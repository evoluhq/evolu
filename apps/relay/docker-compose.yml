services:
  evolu-relay:
    container_name: evolu-relay-server
    image: evolu/relay:latest
    build:
      context: ../../
      dockerfile: apps/relay/Dockerfile
      tags:
        - evolu/relay:latest
        - evolu/relay:dev
    ports:
      - "4000:4000"
    volumes:
      # Use named volume by default, can be overridden with bind mount if needed
      - evolu-relay-data:/app/data
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: ${MEMORY_LIMIT:-1G}
          cpus: ${CPU_LIMIT:-1.0}
        reservations:
          memory: ${MEMORY_RESERVED:-512M}
          cpus: ${CPU_RESERVED:-0.5}
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "const net=require('net');const s=net.connect(4000,'127.0.0.1',()=>{s.end();process.exit(0)});s.on('error',()=>process.exit(1))",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE:-50m}
        max-file: ${LOG_MAX_FILES:-5}
    networks:
      - evolu-network

volumes:
  evolu-relay-data:
    driver: local
    name: evolu-relay-data

networks:
  evolu-network:
    name: evolu-relay-network
    driver: bridge
